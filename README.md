# ik.kontentapi

Модуль для выгрузки товаров с API https://api.breez.ru/api

## Принцип работы

У модуля есть 2 режима работы.
1. Принудительная выгрузка.
2. Регулярная выгрузка.

Принудительная выгрузка запускается из админки вручную. Регулярная стартует автоматически при активации cron скрипта в определенное время. <br>

Зачем нужно 2 cron?
1. Нужен для того, чтобы мониторить не запущена ли принудительная выгрузка. В случае если она запущена, скрипт запускает выгрузку.
2. Нужен для запуска регулярной выгрузки, которая не требует активации вручную из админки bitrix

Модуль можно полностью отключать из настроек модуля. Также можно включать <b>Полную выгрузку</b>.<br>
При выключенной настройке <b>Полная выгрузка</b> для товаров, которые уже хранятся в БД Bitrix выгрузка фото не будет осуществляться.


## Установка

1. Установить модуль. Разместить модуль можно как в папке `/bitrix/modules/`, так и в папке `/local/modules/`.
2. В настройках модуля прописать доступы к api и настроить сам модуль.
3. Создать php файл для запуска выгрузки с произвольный названием.
4. В файл вставить код:

```
<?
$_SERVER['DOCUMENT_ROOT'] = ""; // Нужно заполнить
require($_SERVER['DOCUMENT_ROOT'] . "/bitrix/modules/main/include/prolog_before.php");

set_time_limit(55);

use \Bitrix\Main\Loader;
use ik\Kontentapi\ApiUnloading;
use ik\Kontentapi\Settings;

Loader::includeModule('ik.kontentapi');

$RegularUnload = (isset($_GET['RegularUnload']) && $_GET['RegularUnload'] == 'Y') ? true : false ;

$ApiUnloading = new ApiUnloading($RegularUnload);
$ApiUnloading->StartUnload();

require_once($_SERVER['DOCUMENT_ROOT'] . "/bitrix/modules/main/include/prolog_before.php");
?>
```

5. В переменную `$_SERVER['DOCUMENT_ROOT']` необходимо прописать путь от корня сервера до папки с сайтом.
6. Создать `cron` на исполнение каждую минуту, который будет отвечать за принудительную выгрузку товаров.
7. При необходимости создать `cron` с Get параметром `?RegularUnload=Y` на определенное время, который будет запускать регулярную выгрузку. 